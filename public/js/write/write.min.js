jQuery(document).ready(function(a){getTopics();a("#content_container").dragsort({dragSelector:"li",dragBetween:false,dragSelectorExclude:"input,textarea,span",dragEnd:saveOrder,placeHolderTemplate:"<li class='content_hold'><div></div></li>"});
});var articletype="0",topicId,titleImg,articletitle;var details=[];function saveOrder(){var a=$("#content_container li").map(function(){return $(this).children().html();
}).get();$("input[name=list1SortOrder]").val(a.join("|"));}function getTopics(){$.ajax({url:"/article/getTopics",type:"POST",data:{param1:"value1"},}).done(function(a){if(a.resultCode=="0"){var c={topics:a.topics};
var b=new EJS({url:"/views/write/topicslist.ejs"}).render(c);$("#add_type").html(b);}}).fail(function(){console.log("error");}).always(function(){console.log("complete");
});}$("#type_chose").click(function(a){$("#add_type").toggle("fast");});$("body").on("click","#add_type > div",function(b){var a=$(this).html();var c=$(this).attr("id");
topicId=c;$("#type_chose").css("display","none");$("#add_type").css("display","none");$(".type").append('<div class="type_cont"><span class="art_type_close">×</span><span id="art_type">'+a+"</span></div>");
});$("#original").click(function(a){$(this).addClass("active");articeltype="0";$("#reship").removeClass("active");});$("#reship").click(function(a){$(this).addClass("active");
articletype="1";$("#original").removeClass("active");});$("body").on("click",".art_type_close",function(a){topicId="";$(this).parent(".type_cont").remove();
$("#type_chose").fadeIn("fast");});$("body").on("click","#new_content",function(a){$(this).slideUp("fast");$(this).siblings("#add_cont").slideDown("fast");
});$("body").on("click",".cancel_newcont",function(a){$(this).parent(".appendnew").slideUp("fast");$(this).parent(".appendnew").siblings("#new_content").slideDown("fast");
});$("body").on("click",".content_text > .text_container > span",function(a){var b=this;$(this).parent(".text_container").parent(".content_text").slideToggle("slow",function(){$(b).parent(".text_container").parent(".content_text").remove();
});});$("body").on("click","#add_text",function(a){var b={};var c=$(this).parent("#add_").parent("#add_cont").attr("class");var d=new EJS({url:"views/write/textnew.ejs"}).render(b);
if(c=="appendnew"){$(this).parent("#add_").parent("#add_cont").slideUp("fast");$(this).parent("#add_").parent("#add_cont").siblings("#new_content").slideDown("fast");
$(this).parent("#add_").parent("#add_cont").parent("li").after(d);$("html,body").animate({scrollTop:$(this).offset().top-200},500);}else{$("#content_container").append(d);
$("html,body").animate({scrollTop:$(".footer").offset().top},500);}});$(function(){$("body").on("change",".photoFileUpload",function(){var a=this;fileupload(a);
});$("body").on("change",".cover_img",function(){var a=this;fileupload(a);});});function imgUploadEnd(e,d,a){$("#percent").html("100%");$(".process_container").fadeOut("fast");
var c={url:a};var b=new EJS({url:"/views/write/imgnew.ejs"}).render(c);if(d=="appendnew"){$(e).parent("#myupload").parent("#add_img").parent("#add_").parent("#add_cont").parent("li").after(b);
$("html,body").animate({scrollTop:$(e).offset().top-200},500);}else{$("#content_container").append(b);$("html,body").animate({scrollTop:$(".footer").offset().top},500);
}}function coverUploadEnd(a){$("#percent").html("100%");$(".process_container").fadeOut("fast");$("#cover_img").css({"z-index":"-1",opacity:"0"});titleImg=a;
}function fileupload(h){var e=$(h).attr("class");if(e=="cover_img"){var a=$(h).parent("#cover_img_select");var g=a.find("input[type=file]");var c=g[0].files;
if(window.FileReader){var b=new FileReader();b.onloadend=function(i){$("#cover_img").css({"z-index":"-1",opacity:"0"});$(".cover_pre").html("<img src="+i.target.result+">");
};b.readAsDataURL(c[0]);}}else{var f=$(h).parent("#myupload").parent("#add_img").parent("#add_").parent("#add_cont").attr("class");var a=$(h).parent("#myupload");
var g=a.find("input[type=file]");var c=g[0].files;}var d=new window.FormData(a[0]);if(c.length){process_to_zero();$.ajax({url:"/file",method:"post",data:d,processData:false,contentType:false,success:function(i){if(e=="cover_img"){coverUploadEnd(i.fileUrl);
}else{console.log(i);imgUploadEnd(h,f,i.fileUrl);}},xhr:function(){var i=$.ajaxSettings.xhr();if(onprogress&&i.upload){i.upload.addEventListener("progress",onprogress,false);
return i;}}});}}function textwordnum(d){var e=$(d).val();var b=wordnum;var c=$(d).attr("class");if(c=="text_content"){var a=1000-b;}else{var a=200-b;}if(a<=0){$(d).siblings("h4").children("span").html(0);
}else{$(d).siblings("h4").children("span").html(a);}if(c=="text_content"){delete_more_text(d,e,1000);}else{delete_more_text(d,e,200);}}function send(){$("#send").attr("onclick","a()");
var b=$("#title").val();if(!b){$("#send").attr("onclick","send()");message("请输入标题");return;}else{if(!titleImg){$("#send").attr("onclick","send()");message("请选择封面");
return;}else{if(!topicId){$("#send").attr("onclick","send()");message("请选择类型");return;}}}articletitle=strExchange(b);var a=$("#content_container").children("li").length;
if(a==0){$("#send").attr("onclick","send()");message("什么内容都没有哦！");return;}$("#content_container > li").each(function(c,d){var i=$(d).find("textarea").attr("class");
if(i=="img_content"){var h=$(d).find("#img_url").attr("src");var e=$(d).find("textarea").val();var f={seq:c,url:h,type:"img"};if(e){f.content=strExchange(e);
}details.push(f);if(c==a-1){saveArticle();}}else{if(i=="text_content"){var g=$(d).find(".title_tiny").val();var e=$(d).find("textarea").val();if(!e){$("#send").attr("onclick","send()");
message("内容不能为空");return false;}else{var f={seq:c,content:strExchange(e),title:strExchange(g),type:"txt"};details.push(f);if(c==a-1){saveArticle();}}}}});
}function saveArticle(){var a={title:articletitle,type:articletype,topicId:topicId,details:details,titleImg:titleImg,personInfoId:"0bc36d3f-29fb-4493-ba36-471ef625e35f"};
a=JSON.stringify(a);$.ajax({url:"/article/newart",type:"POST",data:{data:a}}).done(function(b){console.log(b);details=[];if(b.resultCode=="0"){location.href="/user";
}else{if(b.code=="3003"){message_login();}else{message("请重新登录");}}}).fail(function(b){console.log(b);}).always(function(){console.log("complete");});}function reloadNameLength(){}