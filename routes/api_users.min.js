"use strict";var AV=require("leanengine");var moment=require("moment");var router=require("express").Router();var parseurl=require("parseurl");var session=require("express-session");
var express=require("express");var xss=require("xss");var apis=require("./apis");var requestsql=require("./mysqlrequest");var error=require("./error");
var province=require("./province");var app=express();app.use(session({secret:"keyboard cat",resave:false,saveUninitialized:true,userInfo:{},cookie:{maxAge:6000000000}}));
requestsql.init;router.post("/personInfo",function(b,a){GetUserMessage(b,a,function(d,c){ResultProcessed(b,a,d,c);});});router.post("/myInfo",function(b,a){myInfo(b,a,function(d,c){ResultProcessed(b,a,d,c);
});});router.post("/login",function(b,a){Login(b,a,function(d,c){LoginLoadSession(b,a,d,c);});});router.post("/logout",function(b,a){LogoutDecSession(b,a);
});router.post("/phoneCode",function(b,a){PhoneCode(b,a,function(d,c){ResultProcessed(b,a,d,c);});});router.post("/register",function(b,a){Register(b,a,function(d,c){var e=JSON.parse(c.text);
if(c.status!=200){a.send({code:error["3000"]["code"],message:error["3000"]["message"]});}else{if(e.resultCode!=0){a.send({code:error[e.resultCode]["code"],message:"注册失败"});
}else{a.send({code:error["0"]["code"],message:"注册成功"});}}});});router.post("/validateUsername",function(b,a){ValidateUsername(b,a,function(d,c){ResultProcessed(b,a,d,c);
});});router.post("/updatePersonInfo",function(b,a){UpdatePersonInfo(b,a,function(d,c){ResultProcessed(b,a,d,c);});});router.post("/follow",function(b,a){follow(b,a,function(d,c){ResultProcessed(b,a,d,c);
});});router.post("/cancelFollow",function(b,a){cancelFollow(b,a,function(d,c){ResultProcessed(b,a,d,c);});});router.post("/followList",function(b,a){followList(b,a,function(d,c){ResultProcessed(b,a,d,c);
});});router.post("/followerList",function(b,a){followerList(b,a,function(d,c){ResultProcessed(b,a,d,c);});});router.post("/isFollow",function(b,a){isFollow(b,a,function(d,c){ResultProcessed(b,a,d,c);
});});function isFollow(d,b,g){var a=d.session.userInfo;var f=d.body.toUser;if(!a){var c="3003";return g({code:error[c]["code"],message:error[c]["message"]},null);
}else{var e={token:d.session.userInfo.token,"relation.from_user_id":a.userId,"relation.to_user_id":f};console.log(e);requestsql.request(apis.user["isFollow"],e,"form",function(i,h){return g(i,h);
});}}function followerList(d,b,f){var a=d.session.userInfo;if(!a){var c="3003";return f({code:error[c]["code"],message:error[c]["message"]},null);}else{var e={token:d.session.userInfo.token,person_info_id:a.userId,};
requestsql.request(apis.user["followerList"],e,"form",function(h,g){return f(h,g);});}}function followList(b,a,d){var c={pageCurrent:b.body.pageCurrent,pageSize:b.body.pageSize,person_info_id:b.body.userId,};
requestsql.request(apis.user["followList"],c,"form",function(f,e){return d(f,e);});}function cancelFollow(e,b,g){var a=e.session.userInfo;var d=e.body.toUser;
if(!a){var c="3003";return g({code:error[c]["code"],message:error[c]["message"]},null);}else{var f={token:e.session.userInfo.token,"relation.from_user_id":a.userId,"relation.to_user_id":d};
requestsql.request(apis.user["cancelFollow"],f,"form",function(i,h){return g(i,h);});}}function follow(e,b,g){var a=e.session.userInfo;var d=e.body.toUser;
if(!a){var c="3003";return g({code:error[c]["code"],message:error[c]["message"]},null);}else{var f={token:e.session.userInfo.token,"relation.from_user_id":a.userId,"relation.to_user_id":d};
requestsql.request(apis.user["follow"],f,"form",function(i,h){return g(i,h);});}}function myInfo(d,b,f){var a=d.session.userInfo;if(!a){var c="3003";return f({code:error[c]["code"],message:error[c]["message"]},null);
}else{var e={personInfoId:a.userId};requestsql.request(apis.user["personInfo"],e,"form",function(h,g){return f(h,g);});}}function Login(d,b,g){var f=d.body.username;
var a=d.body.password;if(!f||!a){if(!f){var c="1000";}else{if(!a){var c="1003";}}return g({code:error[c]["code"],message:error[c]["message"]},null);}else{var e={"account.username":f,"account.password":a};
requestsql.request(apis.user["login"],e,"form",function(i,h){return g(i,h);});}}function Register(e,b,h){var g=e.body.username;var a=e.body.password;var d=e.body.phoneCode;
if(!g||!a||!d){if(!g){var c="1000";}else{if(!a){var c="1003";}else{if(!d){var c="3002";}}}return h({code:error[c]["code"],message:error[c]["message"]},null);
}else{var f={phoneCode:d,"account.username":g,"account.password":a};requestsql.request(apis.user["register"],f,"form",function(j,i){return h(j,i);});}}function PhoneCode(c,b,e){var a=c.body.phoneNumber;
if(!a){return e({code:error["1001"]["code"],message:error["1001"]["message"]},null);}else{var d={phoneNumber:a};requestsql.request(apis.user["phoneCode"],d,"form",function(g,f){return e(g,f);
});}}function GetUserMessage(b,a,e){var c=b.body.personInfoId;if(!c){return e({code:error["3001"]["code"],message:error["3001"]["message"]},null);}else{var d={personInfoId:c};
requestsql.request(apis.user["personInfo"],d,"form",function(g,f){return e(g,f);});}}function checkUserInfo(a,c){if(!a){return c({code:error["3001"]["code"],message:error["3001"]["message"]},null);
}else{var b={personInfoId:a};requestsql.request(apis.user["personInfo"],b,"form",function(e,d){return c(e,d);});}}function ValidateUsername(b,a,e){var d=b.body.username;
if(!d){return e({code:error["1000"]["code"],message:error["1000"]["message"]},null);}else{var c={username:d};requestsql.request(apis.user["validateUsername"],c,"form",function(g,f){return e(g,f);
});}}function UpdatePersonInfo(k,j,q){var g=k.body.nickname,l=k.body.icon,f=k.body.sign,b=k.body.province,e=k.body.city,h=k.body.desc,a=k.body.weixin,n=k.body.qq,m=k.body.work,d=k.body.school,o=k.body.birthday,i=k.body.sex;
if(g){g=g.replace(/</g,"&lt;").replace(/>/g,"&gt;");}if(f){f=f.replace(/</g,"&lt;").replace(/>/g,"&gt;");}if(b){b=b.replace(/</g,"&lt;").replace(/>/g,"&gt;");
}if(e){e=e.replace(/</g,"&lt;").replace(/>/g,"&gt;");}if(h){h=h.replace(/</g,"&lt;").replace(/>/g,"&gt;");}if(a){a=a.replace(/</g,"&lt;").replace(/>/g,"&gt;");
}if(d){d=d.replace(/</g,"&lt;").replace(/>/g,"&gt;");}if(i){i=i.replace(/</g,"&lt;").replace(/>/g,"&gt;");}var p=k.session.userInfo;if(!p){return q({code:error["3003"]["code"],message:error["3003"]["message"]},null);
}else{var c={token:k.session.userInfo.token,"personInfo.nick_name":g,"personInfo.icon":l,"personInfo.id":p.userId,"personInfo.introduce":f,"personInfo.province":b,"personInfo.city":e,"personInfo.work":m,"personInfo.weixin":a,"personInfo.qq":n,"personInfo.desc":h,"personInfo.school":d,"personInfo.birthday":o,"personInfo.sex":i};
requestsql.request(apis.user["updatePersonInfo"],c,"form",function(s,r){return q(s,r);});}}function ResultProcessed(e,c,d,a){if(d){c.send(d);}else{var f=JSON.parse(a.text);
if(a.status!=200){c.send({code:error["3000"]["code"],message:error["3000"]["message"]});}else{if((f.resultCode=="401")||(f.resultCode=="403")){var b=e.session.userInfo;
b=e.session.userInfo=null;c.send({code:error["3003"]["code"],message:error["3003"]["message"]});}else{if(f.resultCode!="0"){c.send({code:error["-1"]["code"],message:error["-1"]["message"]});
}else{c.send(f);}}}}}function CheckLogin(c,b){var a=c.session.userInfo;if(!a){return false;}else{return true;}}function LoginLoadSession(g,e,f,a){var c=JSON.parse(a.text);
var d=c.personInfo;d=JSON.parse(d);var b=g.session.userInfo;if(c.resultCode=="0"){if(!b){b=g.session.userInfo={username:d.nick_name,userId:d.id,token:c.token};
console.log(g.session.userInfo);e.send({resultCode:"0",message:"success"});}else{e.send({resultCode:"0",message:"success"});}}else{e.send({code:error[c.resultCode]["code"],message:error[c.resultCode]["message"]});
}}function LogoutDecSession(c,b){var a=c.session.userInfo;if(!a){b.send({code:error["3003"]["code"],message:error["3003"]["message"]});}else{a=c.session.userInfo=null;
b.send({code:error["0"]["code"],message:error["0"]["message"]});}}function checkLogin(d,a,c,b){checkUserInfo(d.session.userInfo.userId,function(g,e){if(e){var f=JSON.parse(e.text);
f=JSON.parse(f.personInfo);a.render(c,{type:b,userInfo:f,});console.log(f);}});}module.exports=router;module.exports.ResultProcessed=ResultProcessed;module.exports.checkUserInfo=checkUserInfo;
module.exports.CheckLogin=CheckLogin;module.exports.followList=followList;